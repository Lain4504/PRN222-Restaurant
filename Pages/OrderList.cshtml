@page "/order-list"
@model PRN222_Restaurant.Pages.OrderListModel
@{
    ViewData["Title"] = "Đơn hàng của tôi";
}

<div class="container mx-auto px-4 py-8">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold text-center mb-8">Đơn hàng của tôi</h1>

        @if (!string.IsNullOrEmpty(Model.StatusMessage))
        {
            <div class="alert @(Model.StatusMessage.StartsWith("Error") ? "alert-error" : "alert-success") shadow-lg mb-4">
                <div>
                    <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current flex-shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span>@Model.StatusMessage</span>
                </div>
            </div>
        }

        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <!-- Status Filter -->
                <form method="get" class="mb-4 flex flex-wrap gap-4 items-center">
                    <label for="status" class="font-medium">Lọc theo trạng thái:</label>
                    <select id="status" name="Status" class="select select-bordered select-sm w-auto max-w-xs" onchange="this.form.submit()">
                        <option value="">Tất cả</option>
                        @foreach (var status in Model.AllStatuses)
                        {
                            var isSelected = Model.Status == status;
                            <option value="@status" selected="@(isSelected ? "selected" : null)">
                                @(status == "Pending" ? "Chờ xử lý" :
                                  status == "Preparing" ? "Đang chuẩn bị" :
                                  status == "Served" ? "Đã phục vụ" :
                                  status == "Completed" ? "Hoàn thành" :
                                  status == "Cancelled" ? "Đã hủy" : status)
                            </option>
                        }
                    </select>
                    <input type="hidden" name="CurrentPage" value="@Model.CurrentPage" />
                    <input type="hidden" name="PageSize" value="@Model.PageSize" />
                </form>

                <div class="overflow-x-auto">
                    <table class="table w-full">
                        <thead>
                            <tr>
                                <th>Mã đơn</th>
                                <th>Loại đơn</th>
                                <th>Bàn</th>
                                <th>Ngày đặt</th>
                                <th>Thời gian đặt bàn</th>
                                <th>Tổng tiền</th>
                                <th>Trạng thái</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var order in Model.Orders)
                            {
                                <tr onclick="window.location.href='/order-detail/@order.Id'" style="cursor:pointer;">
                                    <td>#@order.Id</td>
                                    <td>
                                        <span class="badge @(order.OrderType == "Immediate" ? "badge-info" : "badge-warning")">
                                            @(order.OrderType == "Immediate" ? "Tại chỗ" : "Đặt trước")
                                        </span>
                                    </td>
                                    <td>@(order.Table != null ? $"Bàn {order.Table.TableNumber}" : "N/A")</td>
                                    <td>@order.OrderDate.ToString("dd/MM/yyyy HH:mm")</td>
                                    <td>@(order.ReservationTime.HasValue ? order.ReservationTime.Value.ToString("dd/MM/yyyy HH:mm") : "N/A")</td>
                                    <td>@order.TotalPrice.ToString("N0") đ</td>
                                    <td>
                                        <span class="badge 
                                               @(order.Status == "Pending" ? "badge-warning" : 
                                                  order.Status == "Preparing" ? "badge-info" : 
                                                  order.Status == "Served" ? "badge-success" : 
                                                  order.Status == "Completed" ? "badge-success" : 
                                                  order.Status == "Cancelled" ? "badge-error" : "")">
                                            @(order.Status == "Pending" ? "Chờ xử lý" :
                                              order.Status == "Preparing" ? "Đang chuẩn bị" :
                                              order.Status == "Served" ? "Đã phục vụ" :
                                              order.Status == "Completed" ? "Hoàn thành" :
                                              order.Status == "Cancelled" ? "Đã hủy" : order.Status)
                                        </span>
                                    </td>
                                    <td>
                                        <a class="btn btn-sm btn-info" href="/order-detail/@order.Id">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                            </svg>
                                            Chi tiết
                                        </a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="flex justify-between items-center mt-4">
                    <div class="text-sm text-gray-600">
                        Hiển thị @((Model.OrdersResult.Page - 1) * Model.OrdersResult.PageSize + 1) đến 
                        @(Math.Min(Model.OrdersResult.Page * Model.OrdersResult.PageSize, Model.OrdersResult.TotalCount)) 
                        trên tổng số @Model.OrdersResult.TotalCount đơn hàng
                    </div>
                    
                    <div class="join">
                        @if (Model.OrdersResult.HasPreviousPage)
                        {
                            <a href="/order-list?currentPage=@(Model.OrdersResult.Page - 1)&pageSize=@Model.OrdersResult.PageSize" 
                               class="join-item btn btn-outline">«</a>
                        }
                        else
                        {
                            <button class="join-item btn btn-outline" disabled>«</button>
                        }
                        
                        @for (int i = Math.Max(1, Model.OrdersResult.Page - 2); i <= Math.Min(Model.OrdersResult.TotalPages, Math.Max(Model.OrdersResult.Page + 2, 5)); i++)
                        {
                            if (i == Model.OrdersResult.Page)
                            {
                                <button class="join-item btn btn-active">@i</button>
                            }
                            else
                            {
                                <a href="/order-list?currentPage=@i&pageSize=@Model.OrdersResult.PageSize" 
                                   class="join-item btn btn-outline">@i</a>
                            }
                        }
                        
                        @if (Model.OrdersResult.HasNextPage)
                        {
                            <a href="/order-list?currentPage=@(Model.OrdersResult.Page + 1)&pageSize=@Model.OrdersResult.PageSize" 
                               class="join-item btn btn-outline">»</a>
                        }
                        else
                        {
                            <button class="join-item btn btn-outline" disabled>»</button>
                        }
                    </div>
                    
                    <div class="flex items-center">
                        <span class="mr-2">Hiển thị:</span>
                        <select id="pageSize" class="select select-bordered select-sm w-auto max-w-xs">
                            @{
                                bool isSelected5 = Model.OrdersResult.PageSize == 5;
                                bool isSelected10 = Model.OrdersResult.PageSize == 10;
                                bool isSelected20 = Model.OrdersResult.PageSize == 20;
                                bool isSelected50 = Model.OrdersResult.PageSize == 50;
                            }
                            <option value="5" selected="@isSelected5">5</option>
                            <option value="10" selected="@isSelected10">10</option>
                            <option value="20" selected="@isSelected20">20</option>
                            <option value="50" selected="@isSelected50">50</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Xử lý thay đổi số mục trên mỗi trang
            document.getElementById('pageSize').addEventListener('change', function() {
                window.location.href = '/order-list?currentPage=1&pageSize=' + this.value;
            });
        });
    </script>
}